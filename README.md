## **微信机器人框架部署指南**
本项目是一个基于 **wxhook** 的微信 PC 机器人框架，采用 _异步消息总线_ + _智能 Core_ 设计。它屏蔽了底层协议和并发细节，开发者只需要专注于业务逻辑即可。仓库中还包含了一些示例插件，例如统计群里输入的“泡泡”数量、汇率转换、抖音热榜、今日头条热榜和微信 ID 回复等。

本指南旨在帮助您在 Windows 环境下部署并运行机器人。
## **项目结构**
仓库解压后，根目录主要包含以下文件和目录：

| **路径/文件**                               | **说明**                                      |
| --------------------------------------- | ------------------------------------------- |
| main.py                                 | 机器人入口脚本，负责加载配置、注入 DLL 并启动消息总线               |
| config.json                             | 机器人配置文件，用于填写机器人微信号、昵称等参数                    |
| Helper_4.1.2.17.dll、Loader_4.1.2.17.dll | 对应 4.1.2.17 版微信的 32 位辅助 DLL，在启动时会自动注入到微信进程中 |
| plugins/                                | 插件目录，放置所有自定义的插件，每个子目录一个插件                   |
| wxhook/                                 | 原始 wxhook 项目文档及示例，部署时不需要此目录                 |

其中 config.json 和两个 DLL 文件必须与 main.py 位于同一目录。插件的使用与开发详见本文件后文及 plugins/README.md。
## **环境准备**
1. **操作系统**：Windows（32 位或 64 位均可，但需要安装 32 位微信）。
2. **微信版本**：安装 PC 版微信 **4.1.2.17**（下载链接： [夸克分享](https://pan.quark.cn/s/0525a5a17561) ）。此框架通过 DLL 注入技术适配该版本，因此必须使用对应版本和位数的微信客户端。
3. **Python 环境**：安装 **32 位** Python 3.x（>=3.7）。由于 DLL 注入依赖 32 位进程，Python 的位数应与微信一致。
4. **依赖库**：目前示例插件仅依赖 requests 模块，其他依赖为 Python 标准库。您可以按需扩展插件并安装其他第三方库。
## **部署步骤**
1. **准备目录**：将仓库解压后的 wxbot 目录复制到任意位置，例如 C:\\wxbot。部署时不需要 wxhook/ 文件夹，可删除或忽略。
2. **安装依赖**：打开命令提示符，进入 wxbot 目录，执行以下命令安装所需库（根据自己的 Python 环境替换 python）：
```bash
pip install requests
```
2. 如果您需要编写更复杂的插件，可能还需要安装其他第三方包，请根据插件实际需求手动安装。
3. **配置机器人**：编辑 config.json，至少需要修改以下两项：
    - bot_wxid：机器人登陆的微信 ID。例如 "wxid_abcdefg"。可在微信 PC 端点击头像 → 个人信息 → 微信号查看。
    - bot_default_name：机器人在微信中的昵称，用于插件判断是否 @ 机器人。例如 "小明机器人"。当机器人刚进入群聊还未学习昵称时，将使用该字段判断消息是否@。
    其余字段含义如下，仅在特殊情况下需要调整：
    - dll_loader_name / dll_helper_name：分别指定 Loader 和 Helper DLL 的文件名，默认对应 4.1.2.17 版本。若您更换了 DLL 名称，可在此修改。请确保两个 DLL 与 main.py 同目录。
    - max_workers：线程池最大并发数，负责分发消息给插件，默认 10。
4. **启动微信**：确保已经安装好 4.1.2.17 版微信并登录账号。机器人会在运行时自动将 DLL 注入微信进程，因此微信必须处于登录状态。
5. **运行机器人**：在命令提示符进入 wxbot 目录，执行：
```bash
python main.py
```
5. 启动成功后控制台会打印类似 “服务启动。启动消息消费线程…” 的信息，此时机器人已经注入到微信并开始监听消息。程序将保持运行直至您按下 Ctrl+C 终止。
6. **测试插件**：机器人默认已加载 plugins 目录下的示例插件，可以在微信聊天中测试：
    - **泡泡计数**：在群聊中发送连续的中文句号“。”，插件会统计数量并回复“N个泡泡”。   
    - **ID 回复**：私聊或群聊中发送 test，机器人会返回当前聊天窗口（群或个人）的 wxid。
    - **汇率转换**：在群内输入 100 USD CNY（金额 + 空格 + 源货币 + 空格 + 目标货币）获取实时汇率，支持多种币种，详情见插件源码。
    - **抖音热榜**：发送 抖音 或 douyin 获取当前抖音热搜前 10 名及热度。
    - **头条热榜**：发送 头条 或 toutiao 或 热榜 获取今日头条热榜前 10 条新闻标题。
    具体插件效果及可支持的指令请查看各插件目录下的 __init__.py。

## **插件开发指南**
框架使用模块化设计，所有插件位于 plugins/ 目录。开发新插件只需创建一个子目录，并在其中提供 __init__.py，实现一个 Plugin 类并定义 on_message(self, msg_type, data, service) 方法。一个最小的插件示例如下：
```python
# plugins/echo_bot/__init__.py
class Plugin:
    def on_message(self, msg_type, data, service):
        # 1. 只处理文本消息，11046 表示文本类型
        if msg_type != 11046:
            return

        content = data.get('msg', '')  # 获取消息内容
        room_wxid = data.get('room_wxid')  # 如果在群聊，这里是群 ID

        # 2. 自定义业务逻辑：简单回声
        if content == "ping":
            service.send_text(room_wxid, "pong!")
```
service 对象提供了与微信交互的接口，包括：
- send_text(room_wxid, content)：向群聊或个人发送文本消息。
- send_smart_at(room_wxid, to_wxid, text_content)：发送 @ 消息，会自动获取群内昵称。
- is_at_me(room_wxid, content)：判断消息中是否 @ 了机器人，如果是会返回去除 @ 的实际内容。
- bot_wxid 和 bot_default_name：可从 service 获取机器人自身信息。 
框架内部自带线程池，允许在插件内进行阻塞操作（如网络请求），无需手动开启线程。
更多高级用法请查阅 plugins/README.md，或参考现有插件的实现。
## **注意事项**

1. **版本匹配**：此框架依赖于对特定版本微信的逆向接口，DLL 文件仅适配 4.1.2.17 版本的 32 位微信。如更换微信版本，请自行更新相应 DLL，并在 config.json 中调整文件名。
2. **仅供学习与研究**：由于涉及逆向和注入，请勿用于商业用途或侵犯他人权益。使用过程中可能存在风险，请自行承担。
3. **权限和杀软**：部分杀毒软件会拦截 DLL 注入行为，可提前将项目目录添加至信任列表，以免影响运行。
